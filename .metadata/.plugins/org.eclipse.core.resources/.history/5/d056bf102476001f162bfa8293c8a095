package cv.ucc.bsuregistration;

import java.util.List;
import java.util.Map;

import javax.net.SocketFactory;

import examples.Config;
import me.legrange.mikrotik.*;
import me.legrange.mikrotik.impl.*;
import examples.*;
import java.io.BufferedReader;
import java.io.FileReader;

public class BSURegistration {
	
	public static void main(String[] args) throws Exception {
		// TODO Auto-generated method stub
		
		List<BSURegistration> bsus = new LinkedList<BSURegistration>();
		
		try {
			BufferedReader reader = new BufferedReader(new FileReader("IpList.txt"));
			String line;
			while((line = reader.readLine()) != null) {
				BSURegistration bsu = new BSURegistration(line);
				System.out.println(bsu.ip);
				
				if(bsu.connect(bsu.ip)) {
					bsu.getRegistration();
					bsu.disconnect();
				} else {
					System.out.println("Not connected");
				}
				
				bsus.add(bsu);
				bsu = null;
			}
			
		} catch(Exception ex) {
			ex.printStackTrace();
		}
	}

	
	
	public BSURegistration(String ip) {
		super();
		this.ip = ip;
	}

	protected boolean connect(String address) throws Exception {
        try {
        	con = ApiConnection.connect(SocketFactory.getDefault(), address, ApiConnection.DEFAULT_PORT, 2000);
        	con.login(Config.USERNAME, Config.PASSWORD);
        	return true;
        } catch(ApiConnectionException ex) {        	
        	return false;
        }
    }

    protected void disconnect() throws Exception {
        con.close();
    }
    
    protected void getRegistration() throws MikrotikApiException, InterruptedException {
    	List<Map<String, String>> results 
    		= con.execute("/interface/wireless/registration-table/print count-only");
        
    	for (Map<String, String> result : results) {
    		String count = result.values().toString();
            System.out.println(count);
        }
    }
    
    protected ApiConnection con;
    protected String ip;
    protected String registratio;
}
